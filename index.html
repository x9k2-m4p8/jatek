<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årul√≥k - Titkok a Kast√©lyb√≥l</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        /* --- √öJ SZ√çNVIL√ÅG (A log√≥ alapj√°n) --- */
        :root {
            --dark-bg: #0f2a30;       /* S√∂t√©t k√©kes-z√∂ld h√°tt√©r */
            --card-bg: #1a3c45;       /* Kicsit vil√°gosabb k√°rtya h√°tt√©r */
            --gold-text: #e0c090;     /* Arany/b√©zs sz√∂vegsz√≠n */
            --gold-button: #c7b299;   /* Arany gombsz√≠n */
            --button-text: #0f2a30;   /* S√∂t√©t sz√∂veg a gombon */
            --border-color: #2c5f6b;  /* S√∂t√©t szeg√©lysz√≠n */
        }

        body {
            background-color: var(--dark-bg);
            color: var(--gold-text);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 20px;
            margin: 0;
        }
        .logo {
            margin-bottom: 20px;
        }
        .logo img {
            max-width: 300px;
            width: 100%;
            height: auto;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
        }
        input, select {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            width: 80%;
            margin-bottom: 10px;
            background: var(--dark-bg);
            color: var(--gold-text);
        }
        button {
            background-color: var(--gold-button);
            color: var(--button-text);
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            margin-top: 10px;
            transition: background-color 0.2s;
        }
        button:hover { background-color: #e0d0c0; }
        .btn-admin { background-color: #a08c70; color: #fff; } /* Kicsit s√∂t√©tebb arany Tominak */
        .btn-qr { background-color: #2c5f6b; color: var(--gold-text); } /* K√©kes gomb QR-nek */
        
        .role-card {
            font-size: 24px;
            padding: 30px;
            border: 3px solid;
            margin-top: 20px;
            background-color: rgba(0,0,0,0.3);
        }
        .traitor { color: #ff5252; border-color: #ff5252; }
        .faithful { color: #69f0ae; border-color: #69f0ae; }
        
        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; }
        
        /* QR K√≥dok kin√©zete */
        #qr-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .qr-item { background: var(--gold-button); color: var(--button-text); padding: 15px; border-radius: 8px; width: 160px; }
        .qr-item h4 { margin: 5px 0; font-size: 16px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container" id="app">
        <h1 class="logo">
            <img src="https://static.wikia.nocookie.net/thetraitors/images/1/1d/HU_Traitors_Logo.webp/revision/latest?cb=20231106063519" alt="√Årul√≥k log√≥">
        </h1>
        <p>Bet√∂lt√©s...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- !!! FONTOS: M√ÅSOLD BE IDE √öJRA A SAJ√ÅT FIREBASE CONFIGODAT! ---
        const firebaseConfig = {
            apiKey: "AIzaSyCp4szmu2tUhVNSGYV86RXwEEeCjVEznT8",
            authDomain: "arulok-60271.firebaseapp.com",
            projectId: "arulok-60271",
            storageBucket: "arulok-60271.firebasestorage.app",
            messagingSenderId: "368051209444",
            appId: "1:368051209444:web:adf6129b596b6086add8f1",
            measurementId: "G-Y9XY770W2F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const GAME_ID = "szoba_1";
        const PREDEFINED_PLAYERS = ["Tam√°s", "Panni", "Zoli", "Beus", "Luca", "Alex", "D√≥ri", "Lujzi", "Tomi"];
        
        let myId = localStorage.getItem("arulok_player_id");
        if (!myId) {
            myId = "user_" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem("arulok_player_id", myId);
        }

        const appDiv = document.getElementById("app");

        // --- AUTOMATIKUS BEL√âP√âS URL ALAPJ√ÅN ---
        const urlParams = new URLSearchParams(window.location.search);
        const nameFromUrl = urlParams.get('name');

        if (nameFromUrl && PREDEFINED_PLAYERS.includes(nameFromUrl)) {
            joinGame(nameFromUrl).then(() => {
                window.history.replaceState({}, document.title, window.location.pathname);
            });
        }

        // --- F≈ê CIKLUS ---
        onSnapshot(doc(db, "games", GAME_ID), (snapshot) => {
            if (!snapshot.exists()) {
                createInitialGame();
                return;
            }
            const game = snapshot.data();
            render(game);
        });

        // --- UI RAJZOL√ÅS ---
        function render(game) {
            const myPlayer = game.players[myId];

            // 1. √Ållapot: Nincs bel√©pve
            if (!myPlayer) {
                appDiv.innerHTML = `
                    <h1 class="logo">
                        <img src="https://static.wikia.nocookie.net/thetraitors/images/1/1d/HU_Traitors_Logo.webp/revision/latest?cb=20231106063519" alt="√Årul√≥k log√≥">
                    </h1>
                    <div class="card">
                        <h2>√údv a Kast√©lyban!</h2>
                        <p>K√©rlek olvasd be a QR k√≥dodat, vagy v√°laszd ki a neved:</p>
                        <select id="nameSelector">
                            <option value="">-- V√°lassz nevet --</option>
                            ${PREDEFINED_PLAYERS.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                        <button onclick="manualJoin()">Bel√©p√©s</button>
                    </div>
                `;
                
                window.manualJoin = () => {
                    const selectedName = document.getElementById("nameSelector").value;
                    if(selectedName) joinGame(selectedName);
                };
                return;
            }

            // 2. √Ållapot: LOBBY
            if (game.state === "lobby") {
                const isAdmin = myPlayer.name === "Tomi";
                const playersArray = Object.values(game.players);

                let adminPanel = "";
                if (isAdmin) {
                    adminPanel = `
                        <div style="border-top:1px solid var(--border-color); margin-top:20px; padding-top:10px;">
                            <h3>üëë J√°t√©kmester Panel (Csak Tomi)</h3>
                            <button class="btn-admin" id="startBtn">J√ÅT√âK IND√çT√ÅSA</button>
                            <button class="btn-qr" id="qrBtn">QR K√≥dok Gener√°l√°sa</button>
                            <button onclick="resetGame()" style="background:var(--border-color); margin-top:10px; font-size:12px; color:var(--gold-text)">Reset (Mindenkit kir√∫g)</button>
                        </div>
                        <div id="qr-area"></div>
                    `;
                } else {
                    adminPanel = `<p style="color:var(--border-color); font-size:12px;">V√°rjuk Tomit a j√°t√©k ind√≠t√°s√°hoz...</p>`;
                }

                appDiv.innerHTML = `
                    <h1 class="logo">
                        <img src="https://static.wikia.nocookie.net/thetraitors/images/1/1d/HU_Traitors_Logo.webp/revision/latest?cb=20231106063519" alt="√Årul√≥k log√≥">
                    </h1>
                    <div class="card">
                        <h2>V√°rakoz√≥ban...</h2>
                        <p>Szia <strong>${myPlayer.name}</strong>!</p>
                        <hr style="border-color:var(--border-color)">
                        <ul style="text-align:left;">
                            ${playersArray.map(p => `<li>${p.name} ${p.name === myPlayer.name ? '(Te)' : '‚úÖ'}</li>`).join('')}
                        </ul>
                        ${adminPanel}
                    </div>
                `;

                if (isAdmin) {
                    document.getElementById("startBtn").onclick = () => assignRoles(game);
                    document.getElementById("qrBtn").onclick = () => showQRCodes();
                }
                return;
            }

            // 3. √Ållapot: J√ÅT√âK
            if (game.state === "started") {
                const isTraitor = myPlayer.role === "traitor";
                appDiv.innerHTML = `
                    <h1 class="logo">
                        <img src="https://static.wikia.nocookie.net/thetraitors/images/1/1d/HU_Traitors_Logo.webp/revision/latest?cb=20231106063519" alt="√Årul√≥k log√≥">
                    </h1>
                    <div class="card">
                        <h2>A j√°t√©k elkezd≈ëd√∂tt!</h2>
                        <div class="role-card ${isTraitor ? 'traitor' : 'faithful'}">
                            ${isTraitor ? 'üó°Ô∏è √ÅRUL√ì' : 'üõ°Ô∏è H≈∞S√âGES'}
                        </div>
                        <p>${isTraitor ? '√âjszaka gyilkolhattok.' : 'Nappal keress nyomokat!'}</p>
                        ${myPlayer.name === "Tomi" ? '<button onclick="resetGame()" style="background:var(--border-color); margin-top:50px; color:var(--gold-text)">J√°t√©k v√©ge (Reset)</button>' : ''}
                    </div>
                `;
            }
        }

        // --- F√úGGV√âNYEK (V√°ltozatlan) ---

        async function createInitialGame() {
            await setDoc(doc(db, "games", GAME_ID), { state: "lobby", players: {} });
        }

        async function joinGame(name) {
            await updateDoc(doc(db, "games", GAME_ID), {
                [`players.${myId}`]: { name: name, role: null, isAlive: true }
            });
        }

        async function assignRoles(game) {
            const playerIds = Object.keys(game.players);
            if (playerIds.length < 3) return alert("Kev√©s a j√°t√©kos (min 3)!");
            
            playerIds.sort(() => Math.random() - 0.5);
            const traitorCount = Math.max(1, Math.floor(playerIds.length / 4));
            
            const newPlayersData = { ...game.players };
            playerIds.forEach((id, index) => {
                newPlayersData[id].role = index < traitorCount ? "traitor" : "faithful";
            });

            await updateDoc(doc(db, "games", GAME_ID), { players: newPlayersData, state: "started" });
        }

        window.resetGame = async function() {
            if(confirm("Biztos? Mindenki kiesik.")) {
                await setDoc(doc(db, "games", GAME_ID), { state: "lobby", players: {} });
                localStorage.removeItem("arulok_player_id");
                location.reload();
            }
        }

        function showQRCodes() {
            const qrArea = document.getElementById("qr-area");
            qrArea.innerHTML = `<div id="qr-container" style="margin-top:20px;"></div>`;
            const container = document.getElementById("qr-container");
            const baseUrl = window.location.origin + window.location.pathname;

            PREDEFINED_PLAYERS.forEach(name => {
                const wrapper = document.createElement("div");
                wrapper.className = "qr-item";
                wrapper.innerHTML = `<h4>${name}</h4><div id="qr-${name}"></div>`;
                container.appendChild(wrapper);
                new QRCode(document.getElementById(`qr-${name}`), {
                    text: `${baseUrl}?name=${encodeURIComponent(name)}`,
                    width: 128, height: 128,
                    colorDark : "#000000", colorLight : "#c7b299" // QR k√≥d sz√≠ne a gombhoz igaz√≠tva
                });
            });
            alert("K√©sz! G√∂rgess lejjebb a QR k√≥dokhoz.");
        }

    </script>
</body>
</html>
