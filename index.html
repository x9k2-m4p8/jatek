<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√Årul√≥k - Kast√©ly</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 20px;
            margin: 0;
        }
        .container { max-width: 600px; margin: 0 auto; }
        .card {
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            margin-bottom: 20px;
        }
        input {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            border: none;
            width: 70%;
            margin-bottom: 10px;
        }
        button {
            background-color: #444;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            margin-top: 10px;
        }
        .btn-admin { background-color: #b71c1c; } /* Piros gomb Tominak */
        .btn-qr { background-color: #0277bd; } /* K√©k gomb QR gener√°l√°shoz */
        
        .role-card { font-size: 24px; padding: 30px; border: 2px solid #555; margin-top: 20px; }
        .traitor { color: #ff5252; border-color: #ff5252; }
        .faithful { color: #69f0ae; border-color: #69f0ae; }
        
        ul { list-style: none; padding: 0; }
        li { padding: 10px; border-bottom: 1px solid #444; display: flex; justify-content: space-between; }
        
        /* QR K√≥dok kin√©zete */
        #qr-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .qr-item { background: white; color: black; padding: 10px; border-radius: 8px; width: 150px; }
        .qr-item h4 { margin: 5px 0; font-size: 14px; }
    </style>
</head>
<body>

    <div class="container" id="app">
        <h1>Bet√∂lt√©s...</h1>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- M√ÅSOLD BE IDE A FIREBASE CONFIGODAT! ---
         const firebaseConfig = {
    apiKey: "AIzaSyCp4szmu2tUhVNSGYV86RXwEeECjVEznT8",
    authDomain: "arulok-60271.firebaseapp.com",
    projectId: "arulok-60271",
    storageBucket: "arulok-60271.firebasestorage.app",
    messagingSenderId: "368051209444",
    appId: "1:368051209444:web:adf6129b596b6086add8f1",
    measurementId: "G-Y9XY770W2F"
  };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const GAME_ID = "szoba_1";
        // A fix j√°t√©kos lista
        const PREDEFINED_PLAYERS = ["Tam√°s", "Panni", "Zoli", "Beus", "Luca", "Alex", "D√≥ri", "Lujzi", "Tomi"];
        
        let myId = localStorage.getItem("arulok_player_id");
        if (!myId) {
            myId = "user_" + Math.random().toString(36).substr(2, 9);
            localStorage.setItem("arulok_player_id", myId);
        }

        const appDiv = document.getElementById("app");

        // --- AUTOMATIKUS BEL√âP√âS URL ALAPJ√ÅN ---
        // Megn√©zz√ºk, van-e "?name=X" a link v√©g√©n
        const urlParams = new URLSearchParams(window.location.search);
        const nameFromUrl = urlParams.get('name');

        // Ha van n√©v az URL-ben, azonnal elmentj√ºk √©s friss√≠tj√ºk az oldalt (param√©ter n√©lk√ºl)
        if (nameFromUrl && PREDEFINED_PLAYERS.includes(nameFromUrl)) {
            // Itt egy tr√ºkk: azonnal csatlakozunk a h√°tt√©rben
            // De mivel a render ciklusban is ellen≈ërizz√ºk, el√©g csak elind√≠tani a join-t
            joinGame(nameFromUrl).then(() => {
                // Kit√∂r√∂lj√ºk a nevet az URL-b≈ël, hogy sz√©p legyen
                window.history.replaceState({}, document.title, window.location.pathname);
            });
        }

        // --- F≈ê CIKLUS ---
        onSnapshot(doc(db, "games", GAME_ID), (snapshot) => {
            if (!snapshot.exists()) {
                createInitialGame();
                return;
            }
            const game = snapshot.data();
            render(game);
        });

        // --- UI RAJZOL√ÅS ---
        function render(game) {
            const myPlayer = game.players[myId];

            // 1. √Ållapot: Nincs bel√©pve
            if (!myPlayer) {
                appDiv.innerHTML = `
                    <div class="card">
                        <h2>√údv a Kast√©lyban!</h2>
                        <p>K√©rlek olvasd be a QR k√≥dodat, vagy v√°laszd ki a neved:</p>
                        <select id="nameSelector" style="padding:10px; width:80%; margin-bottom:10px; background:#444; color:white; border:none;">
                            <option value="">-- V√°lassz nevet --</option>
                            ${PREDEFINED_PLAYERS.map(name => `<option value="${name}">${name}</option>`).join('')}
                        </select>
                        <button onclick="manualJoin()">Bel√©p√©s</button>
                    </div>
                `;
                
                // Glob√°lisra tessz√ºk a gombhoz
                window.manualJoin = () => {
                    const selectedName = document.getElementById("nameSelector").value;
                    if(selectedName) joinGame(selectedName);
                };
                return;
            }

            // 2. √Ållapot: LOBBY
            if (game.state === "lobby") {
                const isAdmin = myPlayer.name === "Tomi"; // CSAK TOMI AZ ADMIN
                const playersArray = Object.values(game.players);

                let adminPanel = "";
                if (isAdmin) {
                    adminPanel = `
                        <div style="border-top:1px solid #555; margin-top:20px; padding-top:10px;">
                            <h3>üëë J√°t√©kmester Panel (Csak Tomi)</h3>
                            <button class="btn-admin" id="startBtn">J√ÅT√âK IND√çT√ÅSA</button>
                            <button class="btn-qr" id="qrBtn">QR K√≥dok Gener√°l√°sa (Nyomtat√°shoz)</button>
                            <button onclick="resetGame()" style="background:#555; margin-top:10px; font-size:12px">Reset (Mindenkit kir√∫g)</button>
                        </div>
                        <div id="qr-area"></div>
                    `;
                } else {
                    adminPanel = `<p style="color:#888; font-size:12px;">V√°rjuk Tomit a j√°t√©k ind√≠t√°s√°hoz...</p>`;
                }

                appDiv.innerHTML = `
                    <div class="card">
                        <h2>V√°rakoz√≥ban...</h2>
                        <p>Szia <strong>${myPlayer.name}</strong>!</p>
                        <hr>
                        <ul style="text-align:left;">
                            ${playersArray.map(p => `<li>${p.name} ${p.name === myPlayer.name ? '(Te)' : '‚úÖ'}</li>`).join('')}
                        </ul>
                        ${adminPanel}
                    </div>
                `;

                if (isAdmin) {
                    document.getElementById("startBtn").onclick = () => assignRoles(game);
                    document.getElementById("qrBtn").onclick = () => showQRCodes();
                }
                return;
            }

            // 3. √Ållapot: J√ÅT√âK
            if (game.state === "started") {
                const isTraitor = myPlayer.role === "traitor";
                appDiv.innerHTML = `
                    <div class="card">
                        <h2>A j√°t√©k elkezd≈ëd√∂tt!</h2>
                        <div class="role-card ${isTraitor ? 'traitor' : 'faithful'}">
                            ${isTraitor ? 'üó°Ô∏è √ÅRUL√ì' : 'üõ°Ô∏è H≈∞S√âGES'}
                        </div>
                        <p>${isTraitor ? '√âjszaka gyilkolhattok.' : 'Nappal keress nyomokat!'}</p>
                        ${myPlayer.name === "Tomi" ? '<button onclick="resetGame()" style="background:#555; margin-top:50px;">J√°t√©k v√©ge (Reset)</button>' : ''}
                    </div>
                `;
            }
        }

        // --- F√úGGV√âNYEK ---

        async function createInitialGame() {
            await setDoc(doc(db, "games", GAME_ID), { state: "lobby", players: {} });
        }

        async function joinGame(name) {
            // Ellen≈ërizz√ºk, hogy valaki m√°s nem foglalta-e m√°r le ezt a nevet
            // (Ez egy egyszer≈±s√≠tett ellen≈ërz√©s, a UI-ban k√©s≈ëbb jelezhetj√ºk)
            await updateDoc(doc(db, "games", GAME_ID), {
                [`players.${myId}`]: { name: name, role: null, isAlive: true }
            });
        }

        async function assignRoles(game) {
            const playerIds = Object.keys(game.players);
            if (playerIds.length < 3) return alert("Kev√©s a j√°t√©kos (min 3)!");
            
            playerIds.sort(() => Math.random() - 0.5);
            
            // Szab√°ly: H√°ny √°rul√≥ legyen? Pl. 20% vagy min 1.
            const traitorCount = Math.max(1, Math.floor(playerIds.length / 4));
            
            const newPlayersData = { ...game.players };
            playerIds.forEach((id, index) => {
                newPlayersData[id].role = index < traitorCount ? "traitor" : "faithful";
            });

            await updateDoc(doc(db, "games", GAME_ID), { players: newPlayersData, state: "started" });
        }

        window.resetGame = async function() {
            if(confirm("Biztos? Mindenki kiesik.")) {
                await setDoc(doc(db, "games", GAME_ID), { state: "lobby", players: {} });
                localStorage.removeItem("arulok_player_id");
                location.reload();
            }
        }

        // --- QR K√ìD GENER√ÅTOR ---
        function showQRCodes() {
            const qrArea = document.getElementById("qr-area");
            qrArea.innerHTML = `<div id="qr-container" style="margin-top:20px;"></div>`;
            const container = document.getElementById("qr-container");

            // A jelenlegi weboldal c√≠me (pl. te-neved.github.io/app/)
            // Fontos: lev√°gjuk a ? param√©tereket, ha lenn√©nek
            const baseUrl = window.location.origin + window.location.pathname;

            PREDEFINED_PLAYERS.forEach(name => {
                const wrapper = document.createElement("div");
                wrapper.className = "qr-item";
                wrapper.innerHTML = `<h4>${name}</h4><div id="qr-${name}"></div>`;
                container.appendChild(wrapper);

                // QR k√≥d gener√°l√°sa: URL + ?name=N√©v
                new QRCode(document.getElementById(`qr-${name}`), {
                    text: `${baseUrl}?name=${encodeURIComponent(name)}`,
                    width: 128,
                    height: 128
                });
            });
            
            alert("K√©sz! G√∂rgess lejjebb a QR k√≥dokhoz.");
        }

    </script>
</body>
</html>
